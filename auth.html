<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Accesso â€¢ VideoChat26</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./app.css">
</head>
<body>
<header>
  <div class="brand"><div class="logo">ðŸ’¬</div><div>VideoChat26</div></div>
  <div class="pill" id="who">Non loggato</div>
</header>

<div class="container">
  <div class="card box">
    <h3 style="padding:12px 14px;border-bottom:1px solid var(--border);margin:0;">Accesso</h3>
    <div class="box">
      <div class="box" style="border:none;box-shadow:none;background:transparent">
        <div class="box" style="border:none;box-shadow:none;background:transparent;padding:14px">

          <div id="alert" class="alert"></div>

          <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card box" style="box-shadow:none">
              <div class="box" style="padding:14px">
                <h3>Ospite</h3>
                <label>Nick</label>
                <input id="gNick" placeholder="Nick ospite">
                <label>Uomo / Donna</label>
                <select id="gGender">
                  <option value="uomo">Uomo</option>
                  <option value="donna">Donna</option>
                </select>
                <div class="actions">
                  <button id="btnGuest">Entra</button>
                  <a href="./index.html"><button class="ghost" type="button">Indietro</button></a>
                </div>
                <div class="small" style="margin-top:10px">
                  In chat mostreremo solo il <b>nick</b>. (Per ospite serve Anonymous Auth attivo su Supabase.)
                </div>
              </div>
            </div>

            <div class="card box" style="box-shadow:none">
              <div class="box" style="padding:14px">
                <h3>Account</h3>

                <label>Email</label>
                <input id="email" placeholder="Email">

                <label>Password</label>
                <input id="pass" type="password" placeholder="Password (min 6)">

                <div class="hr"></div>

                <label>Nick</label>
                <input id="nick" placeholder="Nick unico (visibile in chat)">

                <label>Uomo / Donna</label>
                <select id="gender">
                  <option value="uomo">Uomo</option>
                  <option value="donna">Donna</option>
                </select>

                <div class="actions">
                  <button id="btnSignup">Registrati</button>
                  <button id="btnLogin" class="secondary">Login</button>
                </div>

                <div class="small" style="margin-top:10px">
                  Dopo login/registrazione, dentro lâ€™app vedrai solo il <b>nick</b>, mai lâ€™email.
                </div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="actions" style="justify-content:center">
            <button class="secondary" id="btnGoRoom" disabled>Vai alla stanza VIDEOCHAT 26</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { el, showAlert, hideAlert, exchangeCodeIfAny, getUser, getMyProfile, upsertMyProfile, signUpEmail, signInEmail, signInGuest } from "./app.js";

await exchangeCodeIfAny();

async function refresh(){
  const user = await getUser();
  if(!user){
    el("who").textContent = "Non loggato";
    el("btnGoRoom").disabled = true;
    return;
  }
  // mostra SOLO nick (no email)
  const prof = await getMyProfile(user);
  const nick = prof?.nick || user.user_metadata?.nick || "Utente";
  el("who").textContent = `Loggato: ${nick}`;
  el("btnGoRoom").disabled = false;
}
await refresh();

el("btnGuest").onclick = async () => {
  hideAlert();
  try{
    const nick = el("gNick").value.trim();
    const gender = el("gGender").value;
    if(nick.length < 3) return showAlert("err","Nick min 3 caratteri.");
    await signInGuest(nick, gender);
    showAlert("ok","Entrato come ospite âœ…");
    await refresh();
  }catch(e){
    showAlert("err", String(e.message || e));
  }
};

el("btnSignup").onclick = async () => {
  hideAlert();
  try{
    const email = el("email").value.trim();
    const pass = el("pass").value;
    const nick = el("nick").value.trim();
    const gender = el("gender").value;

    if(!email.includes("@")) return showAlert("err","Email non valida.");
    if(pass.length < 6) return showAlert("err","Password min 6 caratteri.");
    if(nick.length < 3) return showAlert("err","Nick min 3 caratteri.");

    await signUpEmail(email, pass, nick, gender);
    showAlert("ok","Registrazione inviata! Controlla email (anche spam), poi fai Login.");
  }catch(e){
    showAlert("err", String(e.message || e));
  }
};

el("btnLogin").onclick = async () => {
  hideAlert();
  try{
    const email = el("email").value.trim();
    const pass = el("pass").value;
    await signInEmail(email, pass);

    // dopo login assicuro profilo completo
    const user = await getUser();
    const nick = el("nick").value.trim();
    const gender = el("gender").value;

    if(user && nick.length >= 3){
      try { await upsertMyProfile(user, nick, gender); } catch(e){}
    }

    showAlert("ok","Login effettuato âœ…");
    await refresh();
  }catch(e){
    showAlert("err", String(e.message || e));
  }
};

el("btnGoRoom").onclick = () => {
  window.location.href = "./room.html";
};
</script>
</body>
</html>

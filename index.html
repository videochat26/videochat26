<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VideoChat26</title>

<style>
:root{
  --bg:#0b0f19;
  --panel:#0f172a;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:rgba(255,255,255,.12);
  --ok:#22c55e;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
header{
  padding:12px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.wrap{
  display:grid;
  grid-template-columns:320px 1fr;
  gap:12px;
  padding:12px;
}
.box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
}
.box h3{
  margin:0;
  padding:10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  color:var(--muted);
}
.content{padding:10px}
input,select{
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0b1224;
  color:var(--text);
  width:100%;
  margin-bottom:8px;
}
button{
  padding:10px;
  border-radius:10px;
  border:0;
  background:var(--ok);
  font-weight:700;
  cursor:pointer;
}
button.secondary{background:#334155;color:#fff}
#messages{
  height:40vh;
  overflow:auto;
  border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);
  padding:10px;
}
.msg{margin-bottom:8px}
.meta{font-size:12px;color:var(--muted)}
#video{height:45vh}
</style>
</head>
<body>

<header>
  <div style="font-weight:900">ðŸ’¬ VideoChat26</div>
  <div id="who">Non loggato</div>
</header>

<div class="wrap">

<div class="box">
<h3>Account</h3>
<div class="content">
<input id="email" placeholder="Email">
<input id="pass" type="password" placeholder="Password">

<button id="signup">Registrati</button>
<button id="login" class="secondary">Login</button>
<button id="logout" class="secondary">Logout</button>

<hr style="opacity:.2;margin:14px 0">

<h3>Profilo</h3>
<input id="nick" placeholder="Nick unico">
<button id="saveProfile">Salva Nick</button>
</div>
</div>

<div class="box">
<h3>Stanza</h3>
<div class="content">
<select id="room"></select>
<button id="enter">Entra</button>
<button id="startVideo" class="secondary">Avvia Video</button>

<div id="messages"></div>

<input id="text" placeholder="Scrivi messaggio">
<button id="send">Invia</button>

<div id="video"></div>
</div>
</div>

</div>

<script src="https://meet.jit.si/external_api.js"></script>
<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://rslemfuzuoobslkrhqnx.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_zGJKajM_m40ZAf0B301ycg_iqsTIVSr";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el=id=>document.getElementById(id);

let user=null;
let room=null;
let channel=null;
let jitsi=null;

/* ðŸ” Gestione conferma email */
try{
  const url=new URL(window.location.href);
  if(url.searchParams.get("code")){
    await supabase.auth.exchangeCodeForSession(window.location.href);
    url.searchParams.delete("code");
    window.history.replaceState({}, "", url.toString());
  }
}catch(e){}

/* USER */
async function refreshUser(){
  const {data}=await supabase.auth.getUser();
  user=data.user||null;
  el("who").textContent=user?`Loggato: ${user.email}`:"Non loggato";
}
await refreshUser();

/* SIGNUP */
el("signup").onclick=async()=>{
  const {error}=await supabase.auth.signUp({
    email:el("email").value.trim(),
    password:el("pass").value,
    options:{
      emailRedirectTo:"https://videochat26.github.io/videochat26/"
    }
  });
  if(error)return alert(error.message);
  alert("Controlla email (anche spam)");
};

/* LOGIN */
el("login").onclick=async()=>{
  const {error}=await supabase.auth.signInWithPassword({
    email:el("email").value.trim(),
    password:el("pass").value
  });
  if(error)return alert(error.message);
  await refreshUser();
};

/* LOGOUT */
el("logout").onclick=async()=>{
  await supabase.auth.signOut();
  await refreshUser();
};

/* PROFILO */
el("saveProfile").onclick=async()=>{
  if(!user)return alert("Login prima");
  const nick=el("nick").value.trim();
  if(!nick)return alert("Inserisci nick");
  const {error}=await supabase.from("profiles").upsert({
    user_id:user.id,
    nick
  });
  if(error)return alert(error.message);
  alert("Nick salvato");
};

/* ROOMS */
async function loadRooms(){
  const {data}=await supabase.from("rooms").select("*").order("id");
  el("room").innerHTML=data.map(r=>`<option value="${r.slug}">${r.name}</option>`).join("");
}
await loadRooms();

/* ENTER ROOM */
el("enter").onclick=async()=>{
  if(!user)return alert("Login prima");
  const slug=el("room").value;
  const {data}=await supabase.from("rooms").select("*").eq("slug",slug).single();
  room=data;

  el("messages").innerHTML="";

  const {data:history}=await supabase
    .from("messages")
    .select("*")
    .eq("room_id",room.id)
    .order("created_at",{ascending:true});

  history.forEach(addMsg);

  if(channel) supabase.removeChannel(channel);

  channel=supabase.channel(`room:${room.slug}`)
    .on('postgres_changes',
      {event:'INSERT',schema:'public',table:'messages',filter:`room_id=eq.${room.id}`},
      payload=>addMsg(payload.new)
    )
    .subscribe();

  alert("Entrato in "+room.name);
};

function addMsg(m){
  const div=document.createElement("div");
  div.className="msg";
  div.innerHTML=`<div class="meta"><b>${m.nick}</b></div>${m.body}`;
  el("messages").appendChild(div);
  el("messages").scrollTop=el("messages").scrollHeight;
}

/* SEND via Edge Function */
el("send").onclick=async()=>{
  if(!room)return;
  const body=el("text").value.trim();
  if(!body)return;

  const {data}=await supabase.auth.getSession();
  const token=data.session?.access_token;

  const res=await fetch(`${SUPABASE_URL}/functions/v1/send_message`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${token}`
    },
    body:JSON.stringify({room_slug:room.slug,body})
  });

  const out=await res.json();
  if(!out.ok)return alert(out.error);

  el("text").value="";
};

/* VIDEO */
el("startVideo").onclick=()=>{
  if(!room)return alert("Entra in stanza prima");
  const node=el("video");
  node.innerHTML="";
  if(jitsi) jitsi.dispose();

  jitsi=new JitsiMeetExternalAPI("meet.jit.si",{
    roomName:`VIDEOCHAT26_${room.slug}`,
    parentNode:node,
    lang:"it"
  });
};

</script>
</body>
</html>
